Vconst MR={}\u000awindow.performance=window.performance||{};performance.now=(function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return new Date().getTime();};})();SC.App=React.createClass({displayName:'App',mixins:[RMR.RouterMixin],routes:{'/':'indexHandler','/login':'loginHandler','/logout':'logoutHandler',},ajax:function(url,method,data,callback){console.log('AJAX TO URL:'+url);var xhr=new XMLHttpRequest();xhr.open(method,url,true);this.setState({loading:15});xhr.onreadystatechange=function(){if(xhr.readyState==4){console.log('AJAX END');if(xhr.status){this.setState({status:xhr.status});}\u000asetTimeout(function(){this.setState({loading:-1});}.bind(this),1000);if(xhr.status==200){callback(JSON.parse(xhr.response));}}}.bind(this);xhr.onprogress=function(e){if(e.lengthComputable){console.log('AJAX:'+e.loaded*100/e.total+'%');this.setState({loading:e.loaded*100/e.total});}}.bind(this);xhr.onerror=function(){this.setState({status:500});};xhr.send(data);},getInitialState:function(){return{loading:-1,status:200,current_user:this.props.current_user};},componentDidMount:function(){},componentWillUpdate:function(){if(this.state.url!=window.location.pathname+window.location.search){this.setState({url:window.location.pathname+window.location.search,status:200});}},setCurrentUser:function(current_user){this.setState({current_user:current_user});},render:function(){var getPage=function(){if(this.state.status===200){return this.renderCurrentRoute();}else{return React.createElement(SC.ErrorPage,{errorCode:this.state.status});}}.bind(this);var progressBar=function(){if(this.state.loading>=0){return(React.createElement(RB.ProgressBar,{now:this.state.loading,bsStyle:"danger",style:{position:'fixed',top:'0px',height:'6px',width:'100%',zIndex:100}}));}}.bind(this);return(React.createElement("div",null,progressBar(),React.createElement(SC.NavbarInstance,{name:this.props.name,current_user:this.state.current_user,url:this.state.url}),getPage()));},toInt:function(s,defaultValue){return parseInt(s)?parseInt(s):defaultValue;}, notFound:function(path){return React.createElement(SC.ErrorPage,{errorCode:"404"});},});SC.RedirectPage=React.createClass({displayName:'RedirectPage',componentDidMount:function(){console.log('Redirect to '+this.props.url);SC.Redirect(this.props.url);},render:function(){return(React.createElement("div",null));}});MR.Radar=function(obj){this.name=obj.name;this._weight=obj.weight;this.children=[];this.childOffsetWeight=(obj.children&&obj.children.length)?0:1;this.startAg=0;this.endAg=Math.PI*2;this.weight=0;this.numOfChild=0;this.transformState={};this.updateTag=false;for(var i in obj.children){this.children.push(new MR.Radar(obj.children[i]));this.numOfChild+=this.children[i].numOfChild+1;}\u000athis.transformTo('weight',MR.Radar.countWeightWithChildNum(this._weight,this.numOfChild),1000);}\u000aMR.Radar.CHILDFIX=0.1;MR.Radar.tan3=function(y,x){ag=Math.atan2(y,x);return ag<0?(ag+2*Math.PI):ag;}\u000aMR.Radar.inRange=function(a,v,b){var tmp;if(a>b)tmp=a,a=b,b=tmp;return a<=v&&v<=b;}\u000aMR.Radar.countWeightWithChildNum=function(_weight,numOfChild){return _weight*(1+numOfChild*0.1);}\u000aMR.Radar.prototype.getWeight=function(){return this.weight;}\u000aMR.Radar.prototype.appendChild=function(child){console.log('append Child');if(this.children.length===0){this.transformTo('childOffsetWeight',0,1000);}\u000athis.children.push(child);this.updateTag=true;}\u000aMR.Radar.prototype.transformTo=function(name,value,ms){if(typeof(name)=='undefined'||typeof(value)!='number')return false;if(typeof(ms)=='undefined')ms=1;if(name in this.transformState){this[name]=this.transformState[name].end;}\u000athis.transformState[name]={stamp:window.performance.now(),unit:(value-this[name])/ms,end:value}}\u000aMR.Radar.prototype.drawName=function(ctx,x,y,r,offsetR,isHover){var fullR=offsetR+r,midR=offsetR+r/2,midAg=(this.startAg+this.endAg)/2,X=[],textY=midR*Math.sin(midAg),tmp; tmp=Math.sqrt(fullR*fullR-textY*textY);if(MR.Radar.inRange(this.startAg,MR.Radar.tan3(textY,tmp),this.endAg))X.push(tmp);if(MR.Radar.inRange(this.startAg,MR.Radar.tan3(textY,-tmp),this.endAg))X.push(-tmp); if(offsetR*offsetR-textY*textY>=0){tmp=Math.sqrt(offsetR*offsetR-textY*textY);if(MR.Radar.inRange(this.startAg,MR.Radar.tan3(textY,tmp),this.endAg))X.push(tmp);if(tmp!==0&&MR.Radar.inRange(this.startAg,MR.Radar.tan3(textY,-tmp),this.endAg))X.push(-tmp);} \u000aif(Math.sin(this.startAg)*textY>0){tmp=textY/Math.tan(this.startAg);if(MR.Radar.inRange(offsetR,Math.sqrt(tmp*tmp+textY*textY),fullR))X.push(tmp);}\u000aif(Math.sin(this.endAg)*textY>0){tmp=textY/Math.tan(this.endAg);if(MR.Radar.inRange(offsetR,Math.sqrt(tmp*tmp+textY*textY),fullR))X.push(tmp);} \u000avar l,r;if(X.length>2){var mi=0,midx=midR*Math.cos(midAg);for(var i in X){if(Math.abs(X[i]-midx)<Math.abs(X[mi]-midx))mi=i;}\u000al=X[mi];X.splice(mi,1);mi=0;for(var i in X){if(Math.abs(X[i]-midx)<Math.abs(X[mi]-midx))mi=i;}\u000ar=X[mi];}else{l=X[0],r=X[1];}\u000actx.font='bold 16px Arial,\u5fae\u8edf\u6b63\u9ed1\u9ad4';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillStyle='hsl('+((this.startAg+this.endAg)*90/Math.PI+180)+', 80%, '+(isHover?20:50)+'%)';var pstr=this.name,len=this.name.length,textWidth=Math.abs(l-r);while(len>=0&&ctx.measureText(pstr).width>textWidth){len-=1;pstr=this.name.substring(0,len)+'...';}\u000actx.fillText(pstr,x+(l+r)/2,y+textY,textWidth);}\u000aMR.Radar.prototype.renderComponent=function(ctx,x,y,r,offsetR,isHover){var fullR=r+offsetR;ctx.beginPath();if(offsetR===0){ctx.arc(x,y,r,0,Math.PI*2,false);}else{ctx.moveTo(x+offsetR*Math.cos(this.startAg),y+offsetR*Math.sin(this.startAg));ctx.lineTo(x+fullR*Math.cos(this.startAg),y+fullR*Math.sin(this.startAg));ctx.arc(x,y,fullR,this.startAg,this.endAg,false);ctx.lineTo(x+offsetR*Math.cos(this.endAg),y+offsetR*Math.sin(this.endAg));ctx.arc(x,y,offsetR,this.endAg,this.startAg,true);}\u000actx.fillStyle='hsl('+((this.startAg+this.endAg)*90/Math.PI)+', 80%, '+(isHover?90:50)+'%)';ctx.fill();ctx.stroke(); this.drawName(ctx,x,y,r,offsetR,isHover);}\u000aMR.Radar.prototype.renderChildren=function(ctx,x,y,r,offsetR,mouseHovorRadar){ var sumWeight=this.childOffsetWeight;for(var i in this.children){sumWeight+=this.children[i].getWeight();}\u000avar unitAg=(this.endAg-this.startAg)/sumWeight;var startAg=this.startAg;for(var i in this.children){this.children[i].startAg=startAg;if(i===this.children.length-1&&this.childOffsetWeight===0){this.children[i].endAg=this.endAg;}else{startAg+=unitAg*this.children[i].getWeight();this.children[i].endAg=startAg;}\u000athis.children[i].render(ctx,x,y,r,offsetR+r,mouseHovorRadar);}}\u000aMR.Radar.prototype.render=function(ctx,x,y,r,offsetR,mouseHovorRadar){this.renderComponent(ctx,x,y,r,offsetR,mouseHovorRadar===this);this.renderChildren(ctx,x,y,r,offsetR,mouseHovorRadar);}\u000aMR.Radar.prototype.updateComponent=function(){if(this.updateTag){this.numOfChild=this.children.length;for(var i in this.children){this.numOfChild+=this.children[i].numOfChild;}\u000athis.transformTo('weight',MR.Radar.countWeightWithChildNum(this._weight,this.numOfChild),1000);this.updateTag=false;} \u000afor(var v in this.transformState){var times=window.performance.now()-this.transformState[v].stamp;this[v]+=this.transformState[v].unit*times;if(this.transformState[v].unit>0&&this[v]>=this.transformState[v].end||this.transformState[v].unit<0&&this[v]<=this.transformState[v].end){this[v]=this.transformState[v].end;delete this.transformState[v];}}}\u000aMR.Radar.prototype.updateChildren=function(){var tag=false;for(var i in this.children){tag|=this.children[i].update();}\u000areturn tag;}\u000aMR.Radar.prototype.update=function(){var tag=this.updateTag;if(this.updateChildren()){tag=this.updateTag=true;}\u000athis.updateComponent();return tag;}\u000aMR.RadarPage=React.createClass({displayName:'RadarPage',getInitialState:function(){var radar=new MR.Radar({name:'\u5fc3\u667a\u96f7\u9054',weight:1,});_sam_radar=radar;return{radar:radar,selectRadar:radar};},handleSelect:function(radar){this.setState({selectRadar:radar});},render:function(){return(React.createElement("table",null,React.createElement("tr",null,React.createElement("td",null,React.createElement(MR.RadarCanvasBox,{ref:"radar_box",height:SH,width:SW,radar:this.state.radar,onSelect:this.handleSelect})),React.createElement("td",null,React.createElement(MR.RadarInfoBox,{radar:this.state.selectRadar})))));}});MR.RadarCanvasBox=React.createClass({displayName:'RadarCanvasBox',getInitialState:function(){return{fps:0,r:50,mouseR:0,mouseAg:0,mouseHovorRadar:null};},ctxRender:function(ctx){var that=this,tep1=performance.now(),tep2,fps=0,_render=function(){ fps+=1;tep2=performance.now();if(tep2-tep1>=1000){that.setState({fps:fps});fps=0;tep1=tep2;} \u000athat.props.radar.update();ctx.clearRect(0,0,that.props.width,that.props.height);that.props.radar.render(ctx,that.props.width/2,that.props.height/2,that.state.r,0,that.state.mouseHovorRadar); that.drowMouseLine(ctx,that.props.width/2,that.props.height/2,that.state.mouseR,that.state.mouseAg); window.requestAnimationFrame(_render);};_render();},drowMouseLine:function(ctx,x,y,r,ag){ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+r*Math.cos(ag),y+r*Math.sin(ag));ctx.stroke();},handleMouseMove:function(e){var offset=React.findDOMNode(this.refs.canvas).getBoundingClientRect(),x=e.clientX-offset.left,y=e.clientY-offset.top,midx=this.props.width/2,midy=this.props.height/2,mouseR=Math.sqrt((x-midx)*(x-midx)+(y-midy)*(y-midy)),mouseAg=MR.Radar.tan3((y-midy),(x-midx));that=this,_chekc=function(radar,offsetR){var r=offsetR+that.state.r;if(mouseR>=offsetR&&mouseR<=r&&radar.startAg<=mouseAg&&mouseAg<=radar.endAg){if(that.state.mouseHovorRadar!==radar){that.setState({mouseHovorRadar:radar});}\u000areturn true;}else{for(var i in radar.children){if(_chekc(radar.children[i],r))return true;}}\u000areturn false;};this.setState({mouseR:mouseR,mouseAg:mouseAg});if(!_chekc(this.props.radar,0))this.setState({mouseHovorRadar:null});},handleClick:function(e){if(this.state.mouseHovorRadar){this.props.onSelect(this.state.mouseHovorRadar);}},handleScaling:function(v){var that=this;return function(e){var r=that.state.r;if(v&&r<300)r*=1.5;else if(!v&&r>10)r/=1.5;that.setState({r:r});};},componentDidMount:function(){var canvas=React.findDOMNode(this.refs.canvas);canvas.width=this.props.width;canvas.height=this.props.height;var ctx=canvas.getContext('2d');this.ctxRender(ctx);},render:function(){return(React.createElement("div",null,React.createElement("div",null,"fps: ",this.state.fps,"/s"),React.createElement("div",null,React.createElement("button",{onClick:this.handleScaling(0)},"\u7e2e\u5c0f"),React.createElement("button",{onClick:this.handleScaling(1)},"\u653e\u5927")),React.createElement("canvas",{ref:"canvas",onMouseMove:this.handleMouseMove,onClick:this.handleClick})));}});MR.RadarInfoBox=React.createClass({displayName:'RadarInfoBox',mixins:[React.addons.LinkedStateMixin],getInitialState:function(){return{childName:'',};},handleSubmit:function(e){e.preventDefault();e.stopPropagation();this.props.radar.appendChild(new MR.Radar({name:this.state.childName,weight:1,}));},render:function(){return(React.createElement("div",null,React.createElement("h2",null,this.props.radar.name),React.createElement("form",{onSubmit:this.handleSubmit},React.createElement("div",null,"\u65b9\u584a\u540d\u7a31\uff1a"),React.createElement("input",{valueLink:this.linkState('childName')}),React.createElement("input",{type:"submit",value:"\u589e\u52a0\u65b0\u65b9\u584a"}))));}});
p1
.